# 改进方案：用户中心与“我的”模块（前端）

目标：补齐当前“用户相关页面”能力（按 3 -> 1 -> 2 的顺序），并形成可落地的接口与验收标准，指导后续前后端实现与联调。

约束：站点整体保持“必须登录后访问”（包括首页/题目/题单/每日一题等）。

## 1. 范围与非目标

### 1.1 本次范围（Phase 1）

- 用户中心：
  - `/me/profile` 用户信息概览（只读展示 + 统计 + 跳转入口）
  - `/me/profile/edit` 编辑基本信息（昵称/头像/简介）
  - `/me/profile/password` 修改密码（需旧密码；成功后强制重新登录）
- 我的题目：
  - `/me/problems` 我的题目列表（Tab 状态筛选 + 搜索筛选 + 分页 + 行内操作）
- 我的题单：
  - `/me/collections` 我的题单列表（分页 + 删除 + 分享入口 + 新建入口 + 题目数）
  - `/me/collections/:id/edit` 在现有基础上补齐“编辑题单基础信息”

### 1.2 非目标（Phase 1 不做）

- 游客访问（PRD 方向暂不落地，继续要求登录）
- “撤回审核”“作者下架”（我的题目列表不提供此能力）
- 用户页展示 token/复制 token（明确不暴露）
- “最近题单/最近题目”列表（Profile 仅展示统计并跳转）

## 2. 用户中心（3）

### 2.1 `/me/profile`（只读概览页）

展示字段（只读）：

- 用户名 `username`
- 用户ID `id`
- 注册时间 `createdAt`
- 角色 `roles`（枚举：`USER` / `AUTHOR` / `ADMIN`，可多角色并存）
- 昵称 `nickname`（展示）
- 头像（由 `avatarObjectKey` + 预签名 URL 展示）
- 个人简介 `bio`（展示）

统计卡片（可点击跳转）：

- 我的题目：
  - 按状态计数：`DRAFT / PENDING_REVIEW / PUBLISHED / DISABLED`
  - 点击跳转：`/me/problems`（不做“状态数字点击筛选”）
- 我的题单：
  - 题单总数
  - 点击跳转：`/me/collections`

操作入口：

- “编辑资料” -> `/me/profile/edit`
- “修改密码” -> `/me/profile/password`
- “退出登录” -> 清 token 并跳转 `/login`

### 2.2 `/me/profile/edit`（编辑基本信息）

可编辑字段：

- 昵称 `nickname`（校验：trim 后 1-20；空串不允许提交）
- 简介 `bio`（校验：trim 后 0-200；空串当 `null`）
- 头像 `avatarObjectKey`（可清空为 `null`）

头像更新流程：

1. 前端调用 `POST /api/v1/files` 上传头像获得 `objectKey`
2. 前端调用 `PUT /api/v1/me/profile` 提交 `avatarObjectKey`
3. 展示时通过 `GET /api/v1/files/presigned-get-url` 获取头像 URL

保存成功：

- 跳转回 `/me/profile`

### 2.3 `/me/profile/password`（修改密码）

输入项：

- 旧密码 `oldPassword`
- 新密码 `newPassword`
- 确认新密码 `confirmNewPassword`

成功策略（强制重新登录）：

- 修改成功后：清 token，跳转 `/login`，并提示“密码已修改，请重新登录”

## 3. 我的题目（1）

### 3.1 `/me/problems`（列表页）

Tab（5 个）：

- 全部
- 草稿（`DRAFT`）
- 待审核（`PENDING_REVIEW`）
- 已发布（`PUBLISHED`）
- 已下架（`DISABLED`） 说明：前端文案为“已下架”

筛选项：

- 关键字 `keyword`（匹配范围：标题 + 题干）
- 学科 `subject`（`MATH` / `PHYSICS`）
- 难度区间 `difficultyMin` / `difficultyMax`

排序：

- 默认后端按 `id` 倒序返回（前端不再追加排序）

分页：

- 支持 `page/pageSize`

列表展示字段：

- 标题、学科、难度、可见性、状态
- 发布时间：仅 `PUBLISHED` 显示 `publishedAt`；其它状态显示 `-`

行内操作（按钮可用范围）：

- 编辑：
  - `DRAFT` / `PENDING_REVIEW` / `PUBLISHED` 允许编辑
  - 跳转 `/me/problems/:id/edit`
- 删除：仅 `DRAFT` 可删除
- 提交审核：仅 `DRAFT` 可提交
- 发布：仅 `DRAFT` 可发布（发布流程：作者可直接发布）

顶部操作：

- “新建题目” -> `/me/problems/new`

### 3.2 发布/审核/可见性规则

- 发布：`DRAFT -> PUBLISHED`
- 审核：`DRAFT -> PENDING_REVIEW`（保留接口与入口，但发布可直接进行）
- 已发布编辑：状态保持 `PUBLISHED`（即时更新内容，不回退状态）
- `UNLISTED` shareKey：一旦生成则保留（即使可见性改回 `PUBLIC/PRIVATE`）

## 4. 我的题单（2）

### 4.1 `/me/collections`（列表页）

能力清单：

- 新建入口：`/me/collections/new`
- 分页：`page/pageSize`
- 行内操作：
  - 编辑 -> `/me/collections/:id/edit`
  - 删除 -> 调用删除接口
  - 分享 -> 仅当 `visibility=UNLISTED` 显示；点击弹出对话框展示链接并可复制

列表字段：

- 名称、描述、可见性、题目数 `itemCount`

shareKey 策略：

- shareKey 一旦生成则保留（即使可见性改回 `PUBLIC/PRIVATE`）

### 4.2 `/me/collections/:id/edit`（编辑页增强）

在现有“加题/同步顺序”基础上新增：

- 编辑题单基础信息（名称/描述/可见性）
- 保存调用 `PUT /api/v1/collections/{id}`

## 5. 接口改动（写入 API 设计，后端待实现）

说明：以下为新增/增强接口约定（Base Path：`/api/v1`），均采用统一 `ApiResponse` 包裹。

### 5.1 用户中心

- `GET /me`
  - 返回：`{ id, username, nickname, bio, avatarObjectKey, createdAt, roles: string[] }`
- `PUT /me/profile`
  - 语义：整包覆盖（必须提交 nickname/bio/avatarObjectKey 全量）
  - 允许清空：`avatarObjectKey=null`；`bio` 空串视为 `null`
- `PUT /me/password`
  - 请求：`{ oldPassword, newPassword }`
  - 成功：`code=0`；不返回 token（前端强制重新登录）
- `GET /me/stats`
  - 返回：
    - `problemCountByStatus: { DRAFT, PENDING_REVIEW, PUBLISHED, DISABLED }`
    - `collectionCount: number`

### 5.2 我的题目

- `GET /me/problems`
  - Query：
    - `status`（可选；不传表示全部）
    - `keyword`（标题+题干）
    - `subject`
    - `difficultyMin/difficultyMax`
    - `page/pageSize`
  - 返回：`PageResponse<ProblemSummary>`（包含草稿/待审核/已发布/已下架）

### 5.3 我的题单

- `GET /me/collections`
  - 返回列表项包含：
    - `id, name, description, visibility, itemCount`
    - `shareKey`（当 `visibility=UNLISTED` 时返回；用于前端拼接 `/collections/share/{shareKey}`）
- `PUT /collections/{id}`（作者）
  - 更新：`name/description/visibility`
- `DELETE /collections/{id}`（作者）
  - 删除题单（软删/硬删由后端决定）

## 6. 验收标准（前端）

- 用户中心
  - `/me/profile` 不展示 token；可正确显示用户信息与 roles；统计可跳转
  - 修改密码成功后会清 token 并跳转 `/login`
  - 头像上传流程可完成：上传 -> 保存 profile -> 刷新后仍可显示
- 我的题目
  - Tab 切换正确调用接口并显示对应状态数据
  - 搜索与筛选（keyword+subject+难度区间）可用
  - 行内操作按状态可用：草稿可编辑/删除/发布/提交审核；已发布可编辑
- 我的题单
  - 列表能显示 itemCount；UNLISTED 可打开分享对话框并复制链接
  - 可删除题单；编辑页可修改题单基础信息并保存成功

