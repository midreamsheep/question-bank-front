# 接口设计（API）

本文档用于指导后端实现与前端/测试联调，覆盖 MVP 的核心接口：题目提交（Markdown/LaTeX）、分类/题型/标签、题单分享、每日一题（手动推送）、文件存储（MinIO）、鉴权（JWT）。

## 1. 通用约定

### 1.1 Base URL

- Base Path：`/api/v1`

### 1.2 认证与请求头

- JWT：`Authorization: Bearer <token>`
- traceId：客户端可传 `X-Request-Id`，服务端会透传或生成，并回写到响应头 `X-Request-Id`

### 1.3 统一响应体

统一响应结构：

```json
{
  "code": 0,
  "message": "OK",
  "data": {}
}
```

- `code=0` 表示成功
- 失败时 `data` 通常为 `null`

### 1.4 常用错误码（建议）

| code | 含义 | HTTP |
| --- | --- | --- |
| 40000 | 参数错误 | 400 |
| 40100 | 未认证 | 401 |
| 40300 | 无权限 | 403 |
| 40400 | 资源不存在 | 404 |
| 50000 | 服务端错误 | 500 |
| 50300 | 服务不可用（依赖未启用/不可用） | 503 |

### 1.5 分页约定（建议）

列表接口采用页码分页：

- `page`：从 1 开始
- `pageSize`：默认 20，最大 100

统一分页响应建议：

```json
{
  "items": [],
  "page": 1,
  "pageSize": 20,
  "total": 0
}
```

> 说明：后端将以 `ApiResponse` 包裹上述分页结构。

### 1.6 内容格式约定（题干/解答）

题干与解答均支持两种格式：

- `MARKDOWN`
- `LATEX`

后端不负责 Markdown 与 LaTeX 的互相转换，仅存储并返回格式信息；渲染由前端决定。

## 2. 鉴权接口

### 2.1 登录

- `POST /api/v1/auth/login`
- 认证：否

请求：

```json
{
  "username": "demo",
  "password": "demo"
}
```

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "token": "xxx.yyy.zzz"
  }
}
```

## 3. 系统接口

### 3.1 健康检查

- `GET /api/v1/health`
- 认证：否

响应：`ApiResponse<Void>`

## 4. 文件存储（MinIO）

> 说明：文件上传/下载与题目内容解耦；题目内容中引用图片可采用“对象 key + 预签名 URL”的方式展示。

### 4.1 上传文件

- `POST /api/v1/files`
- 认证：是
- Content-Type：`multipart/form-data`

参数：

- `file`：文件

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "objectKey": "user/demo/20260101/xxx-a.png",
    "originalFilename": "a.png",
    "size": 12345,
    "contentType": "image/png"
  }
}
```

错误：

- MinIO 未启用：`50300`

### 4.2 获取下载预签名 URL

- `GET /api/v1/files/presigned-get-url`
- 认证：是

Query：

- `objectKey`（必填）
- `expiresSeconds`（可选，默认 3600，最小 60）

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "url": "https://..."
  }
}
```

## 5. 题目（Problem）

### 5.1 数据结构（建议）

#### 5.1.1 题目简要信息（ProblemSummary）

```json
{
  "id": 1,
  "title": "一道不等式题",
  "subject": "MATH",
  "difficulty": 3,
  "status": "PUBLISHED",
  "visibility": "PUBLIC",
  "publishedAt": "2026-01-28T10:00:00+08:00",
  "author": {
    "id": 1,
    "nickname": "张三"
  }
}
```

#### 5.1.2 题目详情（ProblemDetail）

```json
{
  "id": 1,
  "title": "一道不等式题",
  "subject": "MATH",
  "difficulty": 3,
  "statementFormat": "MARKDOWN",
  "statement": "题干内容...",
  "solutionFormat": "LATEX",
  "solution": "\\\\text{解：...}",
  "visibility": "PUBLIC",
  "shareKey": null,
  "status": "PUBLISHED"
}
```

### 5.2 创建题目（草稿）

- `POST /api/v1/problems`
- 认证：是

请求（MVP 建议支持）：

```json
{
  "title": "一道不等式题",
  "subject": "MATH",
  "difficulty": 3,
  "statementFormat": "MARKDOWN",
  "statement": "题干 Markdown ...",
  "solutionFormat": "LATEX",
  "solution": "\\\\text{解：...}",
  "visibility": "PUBLIC"
}
```

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "id": 1001,
    "status": "DRAFT",
    "visibility": "PUBLIC",
    "shareKey": null
  }
}
```

规则：

- `difficulty` 必须在 1-5
- `statementFormat/statement` 必填
- `solution` 可选；若填写 `solution` 则 `solutionFormat` 必填
- 若 `visibility=UNLISTED`：
  - 由服务端生成 `shareKey` 并返回

### 5.3 更新题目（草稿/待审核）

- `PUT /api/v1/problems/{id}`
- 认证：是（仅作者或管理员）

请求：同创建结构（可允许部分字段更新，后端决定）

### 5.4 提交审核（可选）

- `POST /api/v1/problems/{id}/submit-review`
- 认证：是（仅作者）

响应：返回最新状态（`PENDING_REVIEW`）

> 说明：是否启用审核策略需产品决策；若 MVP 先不做审核，可不实现本接口。

### 5.5 发布题目（无审核策略时）

- `POST /api/v1/problems/{id}/publish`
- 认证：是（仅作者或管理员）

响应：返回最新状态（`PUBLISHED`）

### 5.6 题目列表

- `GET /api/v1/problems`
- 认证：否（仅返回 PUBLIC 的 PUBLISHED）

Query（建议）：

- `subject`：`MATH/PHYSICS`
- `categoryId`
- `typeId`
- `tagId`
- `difficultyMin`、`difficultyMax`
- `keyword`：关键字（MVP 可先匹配 title）
- `sort`：`LATEST/PUBLISHED_AT/Difficulty`（后续扩展）
- `page`、`pageSize`

响应：`ApiResponse<PageResponse<ProblemSummary>>`

### 5.7 题目详情

- `GET /api/v1/problems/{id}`
- 认证：按可见性决定

访问规则（建议）：

- `PUBLIC`：无需登录可访问（但仅限 PUBLISHED）
- `UNLISTED`：通过 `shareKey` 访问（建议提供专用接口：`/problems/share/{shareKey}`）
- `PRIVATE`：仅作者/管理员可访问

### 5.8 仅链接访问

- `GET /api/v1/problems/share/{shareKey}`
- 认证：否

响应：`ProblemDetail`

### 5.9 删除/下架（后台策略）

- `DELETE /api/v1/problems/{id}`：作者删除自己的草稿（软删除）
- `POST /api/v1/admin/problems/{id}/disable`：管理员下架

> 说明：具体接口与策略可按产品再细化；MVP 可先保留最小集合（创建/更新/列表/详情）。

## 6. 分类 / 题型 / 标签

### 6.1 分类列表

- `GET /api/v1/categories`
- 认证：否

Query：

- `subject`（可选）

### 6.2 题型列表

- `GET /api/v1/problem-types`
- 认证：否

Query：

- `subject`（可选）

### 6.3 标签列表（搜索）

- `GET /api/v1/tags`
- 认证：否

Query：

- `subject`（可选）
- `keyword`（可选）

### 6.4 管理端 CRUD（建议）

（示例，均需管理员权限）

- `POST /api/v1/admin/categories`
- `PUT /api/v1/admin/categories/{id}`
- `POST /api/v1/admin/problem-types`
- `PUT /api/v1/admin/problem-types/{id}`
- `POST /api/v1/admin/tags`

## 7. 题单/合集（Collection）

### 7.1 创建题单

- `POST /api/v1/collections`
- 认证：是

请求：

```json
{
  "name": "不等式训练",
  "description": "按题型整理",
  "visibility": "PUBLIC"
}
```

响应：返回 `id/status/shareKey`

### 7.2 题单详情

- `GET /api/v1/collections/{id}`
- 认证：按可见性决定（同题目）

### 7.3 添加题目到题单

- `POST /api/v1/collections/{id}/items`
- 认证：是（仅作者）

请求：

```json
{
  "problemId": 1001,
  "sortOrder": 0
}
```

### 7.4 调整题单顺序（建议）

- `PUT /api/v1/collections/{id}/items/reorder`

请求：

```json
{
  "items": [
    { "problemId": 1001, "sortOrder": 10 },
    { "problemId": 1002, "sortOrder": 20 }
  ]
}
```

### 7.5 仅链接访问

- `GET /api/v1/collections/share/{shareKey}`

## 8. 每日一题（Daily Problem）

### 8.1 今日每日一题

- `GET /api/v1/daily-problem/today`
- 认证：否

响应：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "day": "2026-01-28",
    "copywriting": "今日推荐：注意构造",
    "problem": { "id": 1001, "title": "...", "subject": "MATH", "difficulty": 3 }
  }
}
```

### 8.2 指定日期每日一题

- `GET /api/v1/daily-problem`
- 认证：否

Query：

- `day=YYYY-MM-DD`

### 8.3 历史列表（建议）

- `GET /api/v1/daily-problems`
- 认证：否

Query：

- `from=YYYY-MM-DD`
- `to=YYYY-MM-DD`
- `page`、`pageSize`（或直接按范围返回）

### 8.4 管理端发布/替换/撤回（建议）

（均需管理员/运营权限）

- 发布或替换：`POST /api/v1/admin/daily-problems`

请求：

```json
{
  "day": "2026-01-28",
  "problemId": 1001,
  "copywriting": "今日推荐：..."
}
```

- 撤回：`POST /api/v1/admin/daily-problems/{day}/revoke`

## 9. 待确认点（影响实现）

1) 审核策略：题目是否必须审核后发布？（决定是否实现 `/submit-review` 与审核后台）
2) UNLISTED 访问策略：仅通过 `shareKey` 访问，还是允许登录用户也可直接访问 `id`？
3) 搜索范围：MVP 是否仅搜索 `title`，还是同时搜索题干/解答？
4) 题干/解答是否允许分别选择格式（本文档建议支持分别选择，最灵活）。

